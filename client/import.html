<!DOCTYPE html>
<!--
	Jericho Comms - Information-theoretically secure communications
	Copyright (c) 2013-2016  Joshua M. David

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation in version 3 of the License.

	You should have received a copy of the GNU General Public License
	along with this program.  If not, see [http://www.gnu.org/licenses/].
-->
<html class="importPadsPage">
	<head>
		<title>Jericho Comms - Load one-time pads</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="height=device-height, width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">
		
		<link rel="icon" type="image/png" sizes="16x16" href="img/favicon.png">
		<link rel="icon" type="image/png" sizes="196x196" href="img/touch-icon-196x196.png">
		
		<link rel="stylesheet" href="css/lib/normalize.css">
		<link rel="stylesheet" href="css/common.css">
		<link rel="stylesheet" href="css/import.css">
		
		<script src="js/lib/jquery.js"></script>
		<script src="js/lib/jquery-ui.js"></script>
		<script src="js/lib/filesaver.js"></script>
				
		<script src="js/lib/cryptojs-core.js"></script>
		<script src="js/lib/cryptojs-x64core.js"></script>
		<script src="js/lib/cryptojs-enc-base64.js"></script>
		<script src="js/lib/cryptojs-hmac.js"></script>
		<script src="js/lib/cryptojs-sha3.js"></script>
		<script src="js/lib/cryptojs-cipher-core.js"></script>
		<script src="js/lib/cryptojs-mode-ctr.js"></script>
		<script src="js/lib/cryptojs-pad-nopadding.js"></script>
		<script src="js/lib/cryptojs-aes.js"></script>
		<script src="js/lib/cryptojs-pbkdf2.js"></script>
		<script src="js/lib/skein.js"></script>
		<script src="js/lib/salsa20.js"></script>
		
		<script src="js/database.js"></script>
		<script src="js/database-crypto.js"></script>
		<script src="js/common.js"></script>
		<script src="js/import.js"></script>		
		<script type="text/javascript">
			$(function()
			{				
				importPads.init();
			});	
		</script>
		<script id="import-pads-pbkdf-worker" type="javascript/worker">
			// Use ECMAScript 5's strict mode
			'use strict';
	
			// Import scripts to be used
			importScripts(baseUrl + '/js/lib/cryptojs-core.js');
			importScripts(baseUrl + '/js/lib/cryptojs-x64core.js');
			importScripts(baseUrl + '/js/lib/cryptojs-enc-base64.js');
			importScripts(baseUrl + '/js/lib/cryptojs-hmac.js');
			importScripts(baseUrl + '/js/lib/cryptojs-sha3.js');
			importScripts(baseUrl + '/js/lib/cryptojs-cipher-core.js');
			importScripts(baseUrl + '/js/lib/cryptojs-mode-ctr.js');
			importScripts(baseUrl + '/js/lib/cryptojs-pad-nopadding.js');
			importScripts(baseUrl + '/js/lib/cryptojs-aes.js');
			importScripts(baseUrl + '/js/lib/cryptojs-pbkdf2.js');
			importScripts(baseUrl + '/js/lib/skein.js');
			importScripts(baseUrl + '/js/lib/salsa20.js');
			importScripts(baseUrl + '/js/database-crypto.js');
			importScripts(baseUrl + '/js/common.js');
			importScripts(baseUrl + '/js/import.js');
			importScripts(baseUrl + '/js/import-worker.js');

			// Get data from the process which started the worker thread
			this.addEventListener('message', function(event)
			{
				// Derive the master key from the passphrase, keyfile and number of iterations. Then derive the 4 sub keys
				var workerData = importPadsWorker.deriveSubKeys(event.data.passphrase, event.data.keyfile, event.data.pbkdfKeccakIterations, event.data.pbkdfSkeinIterations);

				// Send the processed data back to the main thread
				self.postMessage(workerData);
				
			}, false);			
		</script>
		<script id="import-pads-verify-and-decrypt-worker" type="javascript/worker">
			// Use ECMAScript 5's strict mode
			'use strict';
	
			// Import scripts to be used
			importScripts(baseUrl + '/js/lib/cryptojs-core.js');
			importScripts(baseUrl + '/js/lib/cryptojs-x64core.js');
			importScripts(baseUrl + '/js/lib/cryptojs-enc-base64.js');
			importScripts(baseUrl + '/js/lib/cryptojs-hmac.js');
			importScripts(baseUrl + '/js/lib/cryptojs-sha3.js');
			importScripts(baseUrl + '/js/lib/cryptojs-cipher-core.js');
			importScripts(baseUrl + '/js/lib/cryptojs-mode-ctr.js');
			importScripts(baseUrl + '/js/lib/cryptojs-pad-nopadding.js');
			importScripts(baseUrl + '/js/lib/cryptojs-aes.js');
			importScripts(baseUrl + '/js/lib/cryptojs-pbkdf2.js');
			importScripts(baseUrl + '/js/lib/skein.js');
			importScripts(baseUrl + '/js/lib/salsa20.js');
			importScripts(baseUrl + '/js/database-crypto.js');
			importScripts(baseUrl + '/js/common.js');
			importScripts(baseUrl + '/js/import.js');
			importScripts(baseUrl + '/js/import-worker.js');

			// Get data from the process which started the worker thread
			this.addEventListener('message', function(event)
			{
				// Verify the pad indexes, verify the pads, then decrypt them
				var workerData = importPadsWorker.verifyAndDecryptPads(event.data.dbAesKey, event.data.dbSalsaKey, event.data.dbKeccakMacKey, event.data.dbSkeinMacKey, event.data.padData);

				// Send the processed data back to the main thread
				self.postMessage(workerData);
				
			}, false);			
		</script>
	</head>
	<body>
		<div class="pageNavigation">
			<div class="navItem">
				<a href="index.html" class="blueButton">Home</a>
			</div>
			<div class="navItem statusMessage">
				<span class="icon"></span>
				<span class="message"></span>
			</div>
		</div>
		<h2>Load one-time pads</h2>		
		<div class="information">
			This will load the one-time pads from the clipboard or text file into the local storage of this 
			computer/device. Once the pads are loaded you can start chatting.
		</div>
		
		<div class="importMethod">
			<div class="methodTitle">Load method:</div>
			<select id="importMethod">
				<option value="textFile">Load one-time pads from text file</option>
				<option value="clipboard">Load one-time pads from clipboard</option>
			</select>
		</div>
		<div class="method textFile">
			<div class="methodTitle">Choose the one-time pad text file:</div>
			<input id="padFile" class="padFile" type="file" name="padFile" accept="text/plain">
		</div>		
		<div class="method clipboard">
			<div class="methodTitle">
				Open the one-time pad text file, select all text (Ctrl + A), copy (Ctrl + C), paste below (Ctrl + V) then 
				click Load.
			</div>
			<div>
				<input id="padDataClipboardInput" class="padDataClipboardInput" type="text">				
			</div>
			<div>
				<input id="loadPadsFromClipboard" class="blueButton" type="button" value="Load">
			</div>
		</div>
		
		<div class="importSettingsContainer">
			<div class="methodTitle">Enter decryption details:</div>
			<table class="importSettings">
				<tr>
					<th>Passphrase</th>
					<td>
						<input id="importPassphrase" class="longText" type="password">
					</td>
				</tr>
				<tr class="keyfileRow">
					<th>Keyfile</th>
					<td>
						<input id="importKeyfile" class="longText" type="text">
						<input id="importKeyfileFromTextFile" class="importKeyfileFromTextFile" type="file" name="keyfile" accept="text/plain">
					</td>
				</tr>
			</table>
			<table class="importSettings iterations">
				<tr class="keccakIterationsRow">
					<th>PBKDF Keccak iterations</th>
					<td>
						<input id="importPbkdfKeccakIterations" class="numOfIterations" type="text">
					</td>
				</tr>
				<tr class="skeinIterationsRow">
					<th>PBKDF Skein iterations</th>
					<td>
						<input id="importPbkdfSkeinIterations" class="numOfIterations" type="text">
					</td>
				</tr>
			</table>
			<div class="buttonContainer">
				<div class="importButton">
					<input id="importPads" class="blueButton" type="button" value="Import">
				</div>
				<div class="chatButton">
					<a href="chat.html" class="blueButton">Go to chat</a>
				</div>
			</div>
		</div>
	</body>
</html>